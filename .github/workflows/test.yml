name: Test Suite

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # Backend Unit Tests with PHP 8.3
  backend-unit-tests:
    name: Backend Unit Tests (PHP 8.3)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo, pdo_mysql, pdo_sqlite, redis, gd, zip, bcmath
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ runner.os }}-8.2-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-8.2-

      - name: Prepare Laravel directories
        run: |
          mkdir -p backend/bootstrap/cache
          mkdir -p backend/storage/framework/{sessions,views,cache}
          mkdir -p backend/storage/logs
          chmod -R 775 backend/storage
          chmod -R 775 backend/bootstrap/cache

      - name: Install Composer dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        working-directory: backend
        run: cp .env.example .env || cp .env.testing .env || true

      - name: Generate application key
        working-directory: backend
        run: php artisan key:generate --env=testing

      - name: Run unit tests
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'
          CACHE_STORE: array
          QUEUE_CONNECTION: sync
          MAIL_MAILER: array
          SESSION_DRIVER: array
          PUSHER_APP_ID: dummy
          PUSHER_APP_KEY: dummy
          PUSHER_APP_SECRET: dummy
        run: php artisan test --testsuite=Unit --parallel --processes=4

  # Backend Integration Tests with MySQL service
  backend-integration-tests:
    name: Backend Integration Tests (PHP 8.3 + MySQL)
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: bizsocials_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo, pdo_mysql, redis, gd, zip, bcmath
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ runner.os }}-8.3-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-8.3-

      - name: Prepare Laravel directories
        run: |
          mkdir -p backend/bootstrap/cache
          mkdir -p backend/storage/framework/{sessions,views,cache}
          mkdir -p backend/storage/logs
          chmod -R 775 backend/storage
          chmod -R 775 backend/bootstrap/cache

      - name: Install Composer dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        working-directory: backend
        run: cp .env.example .env || cp .env.testing .env || true

      - name: Generate application key
        working-directory: backend
        run: php artisan key:generate --env=testing

      - name: Run integration tests
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: bizsocials_test
          DB_USERNAME: root
          DB_PASSWORD: password
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          CACHE_STORE: redis
          QUEUE_CONNECTION: sync
          MAIL_MAILER: array
          SESSION_DRIVER: array
          PUSHER_APP_ID: dummy
          PUSHER_APP_KEY: dummy
          PUSHER_APP_SECRET: dummy
        run: php artisan test --testsuite=Feature --parallel --processes=4

  # E2E Tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: bizsocials_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Backend
      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo, pdo_mysql, redis, gd, zip, bcmath
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ runner.os }}-8.3-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-8.3-

      - name: Prepare Laravel directories
        run: |
          mkdir -p backend/bootstrap/cache
          mkdir -p backend/storage/framework/{sessions,views,cache}
          mkdir -p backend/storage/logs
          chmod -R 775 backend/storage
          chmod -R 775 backend/bootstrap/cache

      - name: Install Composer dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        working-directory: backend
        run: cp .env.example .env || cp .env.testing .env || true

      - name: Configure environment for E2E
        working-directory: backend
        run: |
          php artisan key:generate --env=testing
          echo "APP_URL=http://localhost:8000" >> .env
          echo "FRONTEND_URL=http://localhost:5173" >> .env

      - name: Run database migrations
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: bizsocials_test
          DB_USERNAME: root
          DB_PASSWORD: password
          PUSHER_APP_ID: dummy
          PUSHER_APP_KEY: dummy
          PUSHER_APP_SECRET: dummy
        run: php artisan migrate --force

      - name: Start Laravel server
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: bizsocials_test
          DB_USERNAME: root
          DB_PASSWORD: password
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          PUSHER_APP_ID: dummy
          PUSHER_APP_KEY: dummy
          PUSHER_APP_SECRET: dummy
        run: php artisan serve --host=0.0.0.0 --port=8000 &

      # Setup Frontend
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Start frontend server
        working-directory: frontend
        run: npm run preview -- --port 5173 --host &

      - name: Wait for servers to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8000/api/health 2>/dev/null || curl -f http://localhost:8000 2>/dev/null; do sleep 2; done' || true
          timeout 60 bash -c 'until curl -f http://localhost:5173 2>/dev/null; do sleep 2; done' || true

      - name: Run Playwright tests
        working-directory: frontend
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:5173
          API_BASE_URL: http://localhost:8000
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/e2e/playwright-report/
          retention-days: 30

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: frontend/e2e/test-results/
          retention-days: 30

  # Static Analysis with PHPStan/Larastan
  static-analysis:
    name: Static Analysis (PHPStan)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo_sqlite
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ runner.os }}-8.3-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-8.3-

      - name: Install Composer dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run PHPStan analysis
        working-directory: backend
        run: ./vendor/bin/phpstan analyse --error-format=github --no-progress

      - name: Run Laravel Pint (code style check)
        working-directory: backend
        run: ./vendor/bin/pint --test

  # Code Coverage with Xdebug
  code-coverage:
    name: Code Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.3 with Xdebug
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo, pdo_sqlite, redis, gd, zip, bcmath, xdebug
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: composer-${{ runner.os }}-8.3-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-8.3-

      - name: Prepare Laravel directories
        run: |
          mkdir -p backend/bootstrap/cache
          mkdir -p backend/storage/framework/{sessions,views,cache}
          mkdir -p backend/storage/logs
          chmod -R 775 backend/storage
          chmod -R 775 backend/bootstrap/cache

      - name: Install Composer dependencies
        working-directory: backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        working-directory: backend
        run: cp .env.example .env || cp .env.testing .env || true

      - name: Generate application key
        working-directory: backend
        run: php artisan key:generate --env=testing

      - name: Run tests with coverage
        working-directory: backend
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'
          CACHE_STORE: array
          QUEUE_CONNECTION: sync
          MAIL_MAILER: array
          SESSION_DRIVER: array
          XDEBUG_MODE: coverage
          PUSHER_APP_ID: dummy
          PUSHER_APP_KEY: dummy
          PUSHER_APP_SECRET: dummy
        run: php artisan test --coverage --min=70 --coverage-clover=coverage.xml

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage.xml
          retention-days: 30

  # Notify on test completion
  notify:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: [backend-unit-tests, backend-integration-tests, e2e-tests, static-analysis, code-coverage]
    if: always()

    steps:
      - name: Check test results
        id: test-results
        run: |
          if [ "${{ needs.backend-unit-tests.result }}" == "failure" ] || \
             [ "${{ needs.backend-integration-tests.result }}" == "failure" ] || \
             [ "${{ needs.e2e-tests.result }}" == "failure" ] || \
             [ "${{ needs.static-analysis.result }}" == "failure" ] || \
             [ "${{ needs.code-coverage.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=❌ Test suite failed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=✅ All tests passed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "${{ steps.test-results.outputs.message }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*BizSocials Test Suite*\n${{ steps.test-results.outputs.message }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.event.head_commit.url }}|${{ github.sha }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Unit Tests:*\n${{ needs.backend-unit-tests.result == 'success' && '✅' || '❌' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Integration Tests:*\n${{ needs.backend-integration-tests.result == 'success' && '✅' || '❌' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*E2E Tests:*\n${{ needs.e2e-tests.result == 'success' && '✅' || '❌' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Static Analysis:*\n${{ needs.static-analysis.result == 'success' && '✅' || '❌' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Code Coverage:*\n${{ needs.code-coverage.result == 'success' && '✅' || '❌' }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Send email notification on failure
        if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "❌ BizSocials Test Suite Failed - ${{ github.ref_name }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions
          body: |
            Test suite failed for BizSocials
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Unit Tests: ${{ needs.backend-unit-tests.result }}
            Integration Tests: ${{ needs.backend-integration-tests.result }}
            E2E Tests: ${{ needs.e2e-tests.result }}
            Static Analysis: ${{ needs.static-analysis.result }}
            Code Coverage: ${{ needs.code-coverage.result }}
            
            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
